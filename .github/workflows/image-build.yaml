# name: image-build

# on:
#   push:
#     branches:
#       - "main"
#   pull_request:
#     branches:
#       - "main"

# jobs:
#   check-changes:
#     runs-on: ubuntu-latest
#     outputs:
#       main: ${{ steps.changes.outputs.main }}
#       jdk: ${{ steps.changes.outputs.jdk }}
#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4

#       - name: Check Changes
#         id: changes
#         uses: dorny/paths-filter@v3
#         with:
#           filters: |
#             main:
#               - ".github/workflows/image-build.yaml"
#               - "Dockerfile"
#             jdk:
#               - ".github/workflows/image-build.yaml"
#               - "Dockerfile.jdk"

#   main-runner-image:
#     needs: check-changes
#     if: ${{ needs.check-changes.outputs.main == 'true' }}
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#         timeout-minutes: 1

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
#         timeout-minutes: 5

#       - name: Login to DockerHub
#         if: ${{ github.ref_name == 'main' }}
#         uses: docker/login-action@v3
#         with:
#           username: ${{ vars.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}
#         timeout-minutes: 1

#       - name: Docker Meta
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: improwised/ghar-image
#           tags: |
#             type=sha,prefix={{branch}}-,suffix=-{{date 'X'}}
#             type=raw,prefix={{branch}}-,value=latest
#         timeout-minutes: 1

#       - name: Set PR Tags
#         if: ${{ github.event_name == 'pull_request' }}
#         run: echo "TAGS=test-main-${{ github.sha }}" >> $GITHUB_ENV

#       - name: Build and Push
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: Dockerfile
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
#           push: ${{ github.ref_name == 'main' }}
#           tags: ${{ env.TAGS || steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           annotations: ${{ steps.meta.outputs.annotations }}

#   jdk-runner-image:
#     needs: check-changes
#     if: ${{ needs.check-changes.outputs.jdk == 'true' }}
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         jdk-version: ["11", "17"]
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#         timeout-minutes: 1

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
#         timeout-minutes: 5

#       - name: Login to DockerHub
#         if: ${{ github.ref_name == 'main' }}
#         uses: docker/login-action@v3
#         with:
#           username: ${{ vars.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}
#         timeout-minutes: 1

#       - name: Docker Meta
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: improwised/ghar-image
#           tags: |
#             type=sha,prefix={{branch}}-jdk-${{ matrix.jdk-version }}-,suffix=-{{date 'X'}}
#             type=raw,prefix={{branch}}-jdk-${{ matrix.jdk-version }}-,value=latest
#         timeout-minutes: 1

#       - name: Set PR Tags
#         if: ${{ github.event_name == 'pull_request' }}
#         run: echo "TAGS=test-jdk-${{ matrix.jdk-version }}-${{ github.sha }}" >> $GITHUB_ENV
#         timeout-minutes: 1

#       - name: Build and Push Docker Image
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: Dockerfile.jdk
#           build-args: |
#             JDK_VERSION=${{ matrix.jdk-version }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
#           push: ${{ github.ref_name == 'main' }}
#           tags: ${{ env.TAGS || steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           annotations: ${{ steps.meta.outputs.annotations }}
#         timeout-minutes: 5
